import numpy as np
import os
from pathlib import Path
# data at r/rtip=0.5, r/rtip = 0.8, r/rtip=0.9
Faxial = np.array([
    [0.0, 1.1, 0.95, 0.85, 0.75, 0.55, 0.40, 0.35, 0.45, 0.15, 0.15, 0.1, 0.1],
    [0.0, 1.5, 1.25, 1.7, 1.6, 2.0, 1.5, 0.6, 1.0, 0.6, 0.85, 0.5, 0.6], 
    [0.0, 1.1, 2.5, 3.5, 1.5, 3.0, 2.75, 1.5, 1.35, 0.6, 0.85, 0.6, 1.75]
]) * 1e-3

Ftangential = np.array([
    [0.0, 1.1, 1.1, 1.1, 0.6, 0.55, 0.3, 0.5, 0.5, 0.25, 0.25, 0.1, 0.1],
    [0., 1.25, 0.35, 1.4, 1.5, 1.5, 0.5, 0.85, 0.75, 0.75, 0.85, 0.6, 0.35],
    [0.0, 1.5, 2.9, 3.2, 1.5, 3.1, 1.75, 0.0, 1.0, 1.0, 0.75, 0.5, 2.0]
]) * 1e-4
r_data = np.array([0.5, 0.8, 0.9])

def interpolateLoadingFromData(r, rtip):
    """
    Interpolate blade loading from tabulated data.

    Parameters
    ----------
    r : array_like
        Radial locations (Nr,)
    rtip : float
        Blade tip radius

    Returns
    -------
    Fblade : ndarray
        Blade loading harmonics (3, Nk, Nr)
        [radial, tangential, axial]
    """

    # normalized radius locations of data
    r_norm = r / rtip                      # (Nr,)

    Nk = Faxial.shape[1]
    Nr = len(r)

    # allocate
    Fblade = np.zeros((3, Nk, Nr))

    # interpolate each harmonic independently
    for k in range(Nk):
        # axial loading
        Fblade[2, k, :] = np.interp(
            r_norm,
            r_data,
            Faxial[:, k],
            left=Faxial[0, k],
            right=Faxial[-1, k]
        )

        # tangential loading
        Fblade[1, k, :] = np.interp(
            r_norm,
            r_data,
            Ftangential[:, k],
            left=Ftangential[0, k],
            right=Ftangential[-1, k]
        )

    # Fblade[0] (radial) remains zero
    return Fblade

R_RT_BEMT = np.array([0.16913581419443968, 0.21028807632533245, 0.25761319288551204, 0.30802469348989814, 0.35946503194612334, 0.42016456570540495, 0.4736625798653083, 0.5292180970471421, 0.5816871870143326, 0.6372427905370404, 0.6825102745639786, 0.740123381108617, 0.78436211362459, 0.8121398722155069, 0.8337447763771371, 0.8553497668796408, 0.8759259195303057, 0.9006172509065793, 0.9160493006389225, 0.9376542911414265, 0.9561727680884129, 0.9798353479537212, 1.0014402521153516])
UZ_BEMT = np.array([3.3033695596108883, 4.0449439632578, 4.955055753854557, 5.764043697843182, 6.674156902878167, 7.617978999741348, 8.29213561973187, 9.101122149282265, 9.842695138490948, 10.41572932631156, 11.022470991522141, 11.662921548560918, 12.13483047533517, 12.505618384377739, 11.359550008736512, 9.910111507709114, 8.393256637463548, 6.943819550874374, 5.6292123738450766, 4.31460519681578, 3.0337083260529067, 1.7528079191944657, 0.2022462787780433])

R_RT_UDNS = np.array([0.1708561290684133, 0.18269583236683912, 0.2, 0.21548271009474898, 0.22914390150475317, 0.2428051234879238, 0.2546448267863496, 0.26466304197319707, 0.27741348932741206, 0.2901639672547935, 0.30291438403584203, 0.3183971247037575, 0.3366120058195411, 0.35938069893377, 0.38488159364220004, 0.4122040376085413, 0.44225868316908357, 0.47959928117593936, 0.5187613672943735, 0.5633879788938756, 0.6116575667165345, 0.6480874512407676, 0.6872495373592018, 0.7182149575486998, 0.7510018047034432, 0.7755919859292504, 0.7983606790434794, 0.8156648466766403, 0.8329690143098012, 0.8475410414950939, 0.8648452091282548, 0.8775956870556363, 0.8903460426903518, 0.8994535443945766, 0.9103824730640466, 0.9213115240261827, 0.9304189034377417, 0.9395264051419665, 0.9550091458098817, 0.9668487879619747, 0.9805099793719789, 1.0005464097456738, 1.0269580790830595, 1.056102011160979, 1.078870704275208, 1.1034608243546822, 1.124407968211, 1.1517304733236742, 1.177231306885771, 1.1990892865173775])
UZ_UDNS = np.array([0.08982008845419774, 0.05988005896946548, 0, 0.2994012999173024, 0.508981506310432, 0.8682638702671759, 1.13772413562977, 1.7065867059796436, 2.3353293352989826, 2.9341319351335873, 3.53293352989822, 4.011976011793894, 4.4311374296501285, 4.970059970515267, 5.329341329402036, 5.6586826588040715, 6.047904047175572, 6.4670654650318085, 6.946107946927483, 7.42514942375318, 7.994011994103056, 8.473053470928754, 8.92215491826972, 9.221557223257001, 9.580837577073792, 10.089821093524174, 10.269461270432572, 10.359280353816795, 9.820359823091604, 8.92215491826972, 7.754490753155218, 6.377245376577609, 4.7604787590521624, 3.5928145939376583, 2.6047906057315515, 1.4970054945165399, 0.7485027472582689, 0.05988005896946548, -0.8982038997519091, -1.4970059970515277, -2.0958085968861324, -2.5149700147423673, -2.5449100442270995, -2.2155692173600516, -1.8562873559382955, -1.6167666175254458, -1.4371259380820613, -1.1676646676494922, -1.0479040471755732, -0.8682633677321888])

R_RT_UDNS_V2 = np.array([0.1698447893569845, 0.1813747228381375, 0.19113082039911308, 0.2017738359201774, 0.21507760532150777, 0.22749445676274946, 0.24079822616407984, 0.2532150776053215, 0.2620842572062084, 0.26917960088691795, 0.2753880266075388, 0.28425720620842576, 0.2940133037694013, 0.3028824833702882, 0.31352549889135256, 0.32682926829268294, 0.3401330376940133, 0.3534368070953437, 0.3694013303769401, 0.38891352549889135, 0.4084257206208426, 0.42971175166297115, 0.45365853658536587, 0.47583148558758315, 0.5006651884700666, 0.5237250554323725, 0.5485587583148559, 0.5698447893569845, 0.5920177383592018, 0.6177383592017738, 0.643458980044346, 0.6682926829268292, 0.6886917960088692, 0.7126385809312639, 0.7330376940133039, 0.7507760532150776, 0.7667405764966742, 0.7800443458980044, 0.7951219512195122, 0.81019955654102, 0.8208425720620842, 0.8305986696230598, 0.8385809312638581, 0.847450110864745, 0.8554323725055433, 0.861640798226164, 0.8669623059866962, 0.8731707317073172, 0.8802660753880267, 0.8855875831485587, 0.8944567627494457, 0.9024390243902438, 0.9130820399113082, 0.9263858093126387, 0.9388026607538802, 0.953880266075388, 0.9662971175166297, 0.97960088691796, 0.9911308203991132, 1.0053215077605322, 1.0186252771618625, 1.0328159645232815, 1.0532150776053215, 1.0753880266075388, 1.1002217294900223, 1.1330376940133038, 1.1738359201773836, 1.1995565410199556])
UZ_UDNS_V2 = np.array([0, -0.058479532163742576, -0.08771929824561298, -0.0292397660818704, 0.2046783625730999, 0.4970760233918128, 0.7602339181286553, 1.0818713450292403, 1.3742690058479532, 1.8421052631578956, 2.222222222222223, 2.690058479532164, 3.128654970760234, 3.4210526315789487, 3.8011695906432763, 4.152046783625732, 4.473684210526317, 4.76608187134503, 5.058479532163743, 5.321637426900585, 5.5847953216374275, 5.84795321637427, 6.111111111111111, 6.374269005847953, 6.637426900584796, 6.900584795321638, 7.222222222222222, 7.4561403508771935, 7.719298245614035, 8.070175438596491, 8.391812865497077, 8.654970760233919, 8.859649122807017, 9.152046783625732, 9.35672514619883, 9.619883040935672, 9.853801169590643, 10.116959064327485, 10.23391812865497, 10.350877192982455, 10.23391812865497, 9.853801169590643, 9.53216374269006, 9.005847953216374, 8.508771929824562, 8.040935672514621, 7.4561403508771935, 6.72514619883041, 5.935672514619883, 5.058479532163743, 4.064327485380117, 3.128654970760234, 2.076023391812866, 0.8187134502923978, 0.029239766081872176, -0.9649122807017534, -1.6374269005847957, -2.163742690058477, -2.4561403508771917, -2.6315789473684212, -2.719298245614034, -2.602339181286549, -2.3684210526315788, -1.9883040935672511, -1.7251461988304087, -1.432748538011694, -1.1111111111111107, -0.9941520467836256])

# directory where THIS file lives
BASE_DIR = Path(__file__).resolve().parent
UDW_EXACT = np.loadtxt(BASE_DIR / "Validation" / "uy_m01R.csv", delimiter=',')[:, 1]
R_RT_UDW = np.loadtxt(BASE_DIR / "Validation" / "uy_m01R.csv", delimiter=',')[:, 0]

OMEGA = 8000/60 * 2 * np.pi
def interpolate_UZ(r_norm, omega):     
    # Uz = np.interp(r_norm, R_RT_UDNS_V2, UZ_UDNS_V2)
    Uz= -np.interp(r_norm, R_RT_UDW, UDW_EXACT)

    # Uz = np.interp(r_norm, R_RT_UDNS, UZ_UDNS)
    # Uz = np.interp(r_norm, R_RT_BEMT, UZ_BEMT)

    # Uz *= omega / OMEGA # arbitrary scaling with OMEGA
    return Uz


BLH_AX_05 = np.array([0.0, 0.0009768270587417792, 0.0010267377835993885, 0.000862744923217244, 0.0006844918557329258, 0.0005062385488950355, 0.0003422459278664631, 0.00022816379234192737, 0.0001426025497288832, 0.0000784313784155287, 0.00004278062130652164, 0.000028520414204348356, 0.000021390071299689657])

BLH_AX_08 = np.array([0, 0.0012459017172579987, 0.0015976155263941738, 0.0016274216966111045, 0.0015141578495562105, 0.0013532039300389487, 0.0011624440404200346, 0.0009836066188878936, 0.000810730231283859, 0.0006557377459252625, 0.0005186287625815445, 0.00039940368148326457, 0.00030402393678908684])

BLH_AX_09 = np.array([0.0, 0.0002442748811462942, 0.0003236641560177663, 0.0003358778590743667, 0.0003358778590743667, 0.0002992367499045678, 0.00028091599031609314, 0.0002442748811462942, 0.0002076337719764953, 0.00017709930933142105, 0.00015267190321822176, 0.00011603079404842358, 0.00009160338793522429])

BLH_TAN_05 = np.array([0.0, 0.00017051261029856036, 0.00017972089526358884, 0.00015275376492782455, 0.00011888044203846894, 0.00008599370598809492, 0.00005869772278163895, 0.00003929454719466271, 0.000023508913137765637, 0.000012985169645126158, 0.000006407811144288681, 0.0000031191507118076935, 4.882148386477889e-7])

BLH_TAN_08 = np.array([0.0, 0.00022116061290690953, 0.0002835287199184236, 0.00028845250568923183, 0.0002687573234751659, 0.00024044549268368578, 0.00020762015508018727, 0.00017561546930826774, 0.00014484174563138353, 0.00011652989918757017, 0.00009314183851456493, 0.0000718053917681741, 0.00005457209461334563])

BLH_TAN_09 = np.array([0.0, 0.00004144196501906807, 0.00005662368040062458, 0.00005990620964877182, 0.00005785462691213803, 0.00005416177172526364, 0.00004800702351536245, 0.00004144196501906807, 0.00003651814766834614, 0.00003077374104950624, 0.000026260233985177434, 0.000020105485775276187, 0.000016002320302008668])

R_RT_THRUST = np.array([0.2009163467517879, 0.2265750401947621, 0.2632302022819766, 0.2934707525330044, 0.32829322111664305, 0.3695303630610251, 0.40068726006384087, 0.4400916469800902, 0.4877434007606588, 0.5408934811501831, 0.5977090100714162, 0.6536082537654182, 0.6985108442415091, 0.7461625980220778, 0.782817821633849, 0.8258877186063642, 0.8717067788833568, 0.9156930226076598, 0.956013756275697])
THRUST = np.array([0.0030701730428162022, 0.004502924127286164, 0.0065497015752190345, 0.009005848254572355, 0.011461981192091804, 0.015350878955915087, 0.01903509210402812, 0.023333331615604084, 0.030292402422243597, 0.03888889518722941, 0.04973684314494138, 0.06038011335786005, 0.07102339044169567, 0.08248537850470444, 0.09374268882291992, 0.10499999914113539, 0.11400584739570778, 0.12301169565028015, 0.12342105113986673])

R_RT_TAN = np.array([0.20094565536988374, 0.236879480127627, 0.28416078839532616, 0.32955084941136603, 0.3900709519287886, 0.45721045157107276, 0.5290780375984512, 0.5782505931178098, 0.6387706956352324, 0.6992908616407628, 0.7607564925518531, 0.8193853478176163, 0.8628842250701048, 0.9139479643530146, 0.9574468416055033])
TAN = np.array([0.000823698389888226, 0.0010838161219675886, 0.0017774556458161387, 0.0022976881993386987, 0.003208091529708, 0.004465317532637722, 0.005895953416529583, 0.007283238285498992, 0.008497110362870099, 0.010101156127724099, 0.011488439541375425, 0.01304913283598889, 0.015606935856770796, 0.018424855154313986, 0.02436416176874314])



R_EXACT = np.loadtxt(BASE_DIR / "Validation" / "radius.csv", delimiter=',')
T_EXACT = np.loadtxt(BASE_DIR / "Validation" / "thrust.csv", delimiter=',')
Q_EXACT = np.loadtxt(BASE_DIR / "Validation" / "tanforce.csv", delimiter=',')
DR_EXACT = R_EXACT[1] - R_EXACT[0]
RT = R_EXACT[-1]
R_RT_EXACT = R_EXACT / RT
DT_EXACT = T_EXACT / DR_EXACT
SDQ_EXACT = Q_EXACT / DR_EXACT




# ------------------------------------------------------------------
# # common r/rt interval
# r_min = max(R_RT_THRUST.min(), R_RT_TAN.min())
# r_max = min(R_RT_THRUST.max(), R_RT_TAN.max())

# # arbitrary common grid
# N = 200
# r_rt_common = np.linspace(r_min, r_max, N)
# 
# # # interpolate
# # thrust_i = np.interp(r_rt_common, R_RT_THRUST, THRUST)
# # tan_i    = np.interp(r_rt_common, R_RT_TAN,    TAN)
# thrust_i = np.interp(R_EXACT/RT,r_rt_common, T_EXACT)
# tan_i = np.interp(R_EXACT/RT,r_rt_common, Q_EXACT)


# DR0 = (0.1-0.016) / 20
# TREFR1 = 0.17168
# thrust_per_unit_span_i = thrust_i / DR0 *  TREFR1 / thrust_i[-1]
# tan_per_unit_span_i = tan_i / DR0 *  TREFR1 / thrust_i[-1]

# lift_i = np.sqrt(thrust_i**2 + tan_i**2) 
# lift_per_unit_span_i = lift_i


BLH_BEAM_AX_09 = [0.0, 0.0012647059506427714, 0.0017222222438651588, 0.001611111141411222, 0.0013856208254054612, 0.0011013072522306126, 0.0008431372588740762, 0.0006372549238074191, 0.00045424830678781307, 0.00033660104446975715, 0.00024183012351532054, 0.0001568626008796963, 0.00011437908888851146]

BLH_BEAM_AX_08 = [0.0, 0.0012340425531914894, 0.0015562310030395137, 0.0013465045592705167, 0.0010790273556231004, 0.0007963525835866261, 0.0005653495440729483, 0.0004012158054711246, 0.00026443768996960485, 0.00017933130699088147, 0.00011854103343465045, 0.00006990881458966565, 0.000051671732522796354]

BLH_BEAM_AX_05 = [0.0, 0.0006529411764705882, 0.0006000000000000001, 0.00035882352941176473, 0.00020882352941176471, 0.00011176470588235294, 0.00005294117647058824, 0.00002647058823529412, 0.000011764705882352942, 0.000008823529411764707, 0.000005882352941176471, 0.000005882352941176471, 0.000005882352941176471]

BLH_BEAM_TAN_05 = [0.0, 0.0007063636363636364, 0.0005781818181818182, 0.00035454545454545455, 0.00021818181818181818, 0.00009272727272727273, 0.000057272727272727274, 0.000021818181818181818, 0.000010909090909090909, 0.000013636363636363637, 0.0000054545454545454545, 0.0000027272727272727272, 0.0000027272727272727272]

BLH_BEAM_TAN_08 = [0.0, 0.0012995633187772924, 0.0015196506550218339, 0.001331004366812227, 0.0010637554585152837, 0.0007676855895196506, 0.0005580786026200873, 0.00038253275109170304, 0.00025676855895196505, 0.00017816593886462882, 0.00010480349344978165, 0.00007336244541484716, 0.000044541484716157205]

BLH_BEAM_TAN_09 = [0.0, 0.0013334315169366716, 0.001688659793814433, 0.0016011782032400589, 0.0013784977908689248, 0.0010868924889543446, 0.0008430044182621502, 0.0006256259204712813, 0.0004533136966126657, 0.0003313696612665685, 0.00022002945508100148, 0.00016170839469808543, 0.00011134020618556701]


# x = [266.8538411099623, 532.7721995692442, 790.9031848729285, 1070.263258525417, 1328.386327000871, 1608.549079014322, 1853.9435858492855, 2136.7746028724687, 2417.564201131902, 2718.4187303002677]
SPL_BLADE_01 = [66.07476635514018, 51.191588785046726, 36.30841121495327, 40.39719626168224, 38.76168224299065, 36.30841121495327, 33.36448598130841, 29.929906542056074, 25.8411214953271, 20.11682242990654]
FPLUS= np.arange(1, len(SPL_BLADE_01)+1, 1)

SPL_BEAM_01 = [48.41121495327103, 55.771028037383175, 57.73364485981308, 58.060747663551396, 57.242990654205606, 56.098130841121495, 54.4626168224299, 52.336448598130836, 50.70093457943925, 47.26635514018691]

SPL_BLADE_02 = [61.48230088495575, 48.93805309734513, 34.690265486725664, 35.309734513274336, 32.676991150442475, 27.721238938053094, 21.836283185840706, 14.0929203539823, 6.65929203539823, 6.814159292035398]

SPL_BEAM_02 = [25.862831858407077, 8.362831858407079] + [-1e6] * 8